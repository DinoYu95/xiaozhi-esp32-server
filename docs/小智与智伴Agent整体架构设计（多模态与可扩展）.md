# 小智与智伴 Agent 整体架构设计（多模态与可扩展）

## 一、总体原则

- **设备只对接 xiaozhi-server**：端侧（如 ESP32/App）仅与 xiaozhi-server 通信，不直连下游声纹、ASR、视觉、智伴 Agent、TTS 等。
- **xiaozhi-server 为编排服务**：负责连接管理、协议解析、会话上下文，并按需调用下游能力（声纹、ASR、视觉、zhiban-agent、TTS 等）。
- **多模态输入**：以用户主诉求（语音/文本）为主，可叠加环境上下文（如视觉识别结果、设备状态）。
- **多形态输出**：TTS 播报 + 必要时下发指令（如 OTA、配置）给设备。

---

## 二、架构示意

```
                    ┌─────────────────────────────────────────────────────────┐
                    │                     xiaozhi-server                       │
                    │  （唯一对端：设备/App 只连本服务，不直连下游）              │
                    │  连接管理 · 协议 · 会话 · 编排 · 配置                     │
                    └─────────────────────────────────────────────────────────┘
                                              │
          ┌───────────────────────────────────┼───────────────────────────────────┐
          │                                   │                                   │
          ▼                                   ▼                                   ▼
   ┌─────────────┐                    ┌─────────────┐                    ┌─────────────┐
   │ 声纹 / ASR  │                    │ 视觉（VLLM） │                    │ zhiban-agent│
   │ (多为第三方) │                    │ (多为第三方) │                    │ (自建可扩)  │
   └─────────────┘                    └─────────────┘                    └─────────────┘
          │                                   │                                   │
          ▼                                   ▼                                   ▼
   ┌─────────────┐                    ┌─────────────┐                    ┌─────────────┐
   │    TTS      │                    │  LLM/意图  │                    │  记忆/知识  │
   │ (多为第三方) │                    │ (多为第三方)│                    │ (自建可扩)  │
   └─────────────┘                    └─────────────┘                    └─────────────┘
```

---

## 三、下游能力说明

| 能力 | 说明 | 扩展方式 |
|------|------|----------|
| 声纹 | 识别说话人，多用于亲子场景 | 多为第三方 API，扩展依赖厂商能力与配额 |
| ASR | 语音转文字 | 多为第三方 API（如腾讯、阿里、字节等），扩展依赖对方 |
| 视觉 | 图像/视频理解（VLLM） | 多为第三方 API，扩展依赖对方 |
| zhiban-agent | 儿童对话与长期记忆（router → load_memory → 各 agent → save_memory） | 自建服务，可多实例水平扩展 |
| TTS | 文字转语音 | 多为第三方 API，扩展依赖对方 |
| LLM/意图 | 大模型与意图识别 | 多为第三方 API，扩展依赖对方 |

**要点**：下游多为第三方 API 时，整体扩展受限于各厂商的并发与配额；**自建部分**（如 xiaozhi-server、zhiban-agent、自建记忆/知识）可通过多实例、负载均衡做水平扩展。

---

## 四、服务端分层（简述）

1. **接入层**：设备/App 连接、鉴权、协议解析（如 WebSocket）。
2. **编排层**：会话与上下文管理，决定何时调用 ASR、何时上视觉、何时调 zhiban-agent、何时调 TTS。
3. **能力层**：声纹、ASR、视觉、zhiban-agent、TTS、LLM 等具体调用与结果回写。
4. **数据层**：配置、记忆、知识库等（部分在 xiaozhi，部分在 zhiban-agent 等子服务）。

---

## 五、部署与扩展

- **单机部署**：xiaozhi-server + 各下游 API 配置即可跑通。
- **流量上来后**：  
  - xiaozhi-server、zhiban-agent 等自建服务可多实例 + 负载均衡。  
  - 声纹/ASR/视觉/TTS/LLM 依赖第三方时，需按厂商配额与 SLA 扩容或更换实例/区域。

---

## 六、与智伴 Agent（zhiban-agent）的关系

- zhiban-agent 作为**下游对话与长期记忆服务**，由 xiaozhi-server 在需要时调用（如儿童对话、知识问答、故事、游戏等）。
- 设备不直连 zhiban-agent；所有请求经 xiaozhi-server 编排后，由服务端请求 zhiban-agent，再将回复经 TTS 等返回设备。
- 记忆与 Mem0 对齐的说明见 zhiban-agent 仓库内文档：`记忆模块与Mem0架构对比与对齐.md`。
