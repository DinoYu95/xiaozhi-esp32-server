# 家长端设备绑定 - 本地测试步骤

没有真实设备时，用「模拟设备上报」拿到 6 位绑定码，再用家长端绑定接口完成绑定。

---

## 一、流程说明

1. **模拟设备上报**：调用 OTA 接口（与真实设备上报相同），服务端会生成 6 位激活码并写入 Redis。
2. **家长端绑定**：用上一步返回的 `activation.code` 调用家长端绑定接口，带上登录后的 token。

无需改 test_page（它是 WebSocket 测试页，不负责绑定），也无需在网页上做任何操作。

---

## 二、具体步骤

### 1. 先拿到家长端 token（若还没有）

```bash
# Redis 里先写入验证码（仅测试用）
# redis-cli:
SET "sys:captcha:sms:Validate:Code:13800138000" "123456"
EXPIRE "sys:captcha:sms:Validate:Code:13800138000" 300

# 手机号登录，拿到 token
curl -s -X POST "http://localhost:8002/xiaozhi/parent-api/auth/phone/login" \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

从响应里取出 `data.token`，后面记为 `YOUR_PARENT_TOKEN`。

---

### 2. 模拟设备上报，获取 6 位绑定码

设备 ID 必须是类 MAC 格式（如 `aa:bb:cc:dd:ee:ff`），且**该设备当前不能在库表 `ai_device` 里已存在**，否则不会返回激活码。

```bash
# 用一个新的 MAC 地址（例如 aa:bb:cc:dd:ee:01），POST 到 OTA 接口
curl -s -X POST "http://localhost:8002/xiaozhi/ota/" \
  -H "Content-Type: application/json" \
  -H "Device-Id: aa:bb:cc:dd:ee:01" \
  -d '{"application":{"version":"1.0.0"},"board":{"type":"test"}}'
```

在返回的 JSON 里找到 `activation.code`，即 6 位数字，例如 `"123456"`。若没有 `activation`，说明该 Device-Id 已在 `ai_device` 中，换一个 MAC 再试（如 `aa:bb:cc:dd:ee:02`）。

---

### 3. 用绑定码调用家长端绑定接口

把下面命令里的 `YOUR_PARENT_TOKEN` 和 `上一步的6位码` 替换成实际值：

```bash
curl -s -X POST "http://localhost:8002/xiaozhi/parent-api/device/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_PARENT_TOKEN" \
  -d '{"code":"上一步的6位码"}'
```

成功示例：`{"code":0,"msg":"success","data":{"deviceId":"aa:bb:cc:dd:ee:01","message":"绑定成功"}}`。

---

### 4. 查看已绑定设备列表（可选）

```bash
curl -s -X GET "http://localhost:8002/xiaozhi/parent-api/device/list" \
  -H "Authorization: Bearer YOUR_PARENT_TOKEN"
```

---

## 三、一键脚本示例（替换 token 与 code 后执行）

```bash
# 1）模拟设备上报，取 code（注意 Device-Id 每次可改最后一节避免重复）
CODE=$(curl -s -X POST "http://localhost:8002/xiaozhi/ota/" \
  -H "Content-Type: application/json" \
  -H "Device-Id: aa:bb:cc:dd:ee:01" \
  -d '{"application":{"version":"1.0.0"},"board":{"type":"test"}}' \
  | grep -o '"code":"[0-9]*"' | cut -d'"' -f4)
echo "绑定码: $CODE"

# 2）家长端绑定（把 YOUR_PARENT_TOKEN 换成真实 token）
curl -s -X POST "http://localhost:8002/xiaozhi/parent-api/device/bind" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_PARENT_TOKEN" \
  -d "{\"code\":\"$CODE\"}"
```

---

## 四、常见问题

| 现象 | 可能原因 |
|------|----------|
| OTA 返回无 `activation` | 该 `Device-Id` 已在 `ai_device` 表中，换一个 MAC 再试。 |
| 绑定返回 20004 绑定码无效 | 绑定码过期或错误，重新执行步骤 2 拿新 code 再绑。 |
| 绑定返回 20005 设备已被其他账号绑定 | 该设备已绑过其他家长，需先解绑或换新 Device-Id 上报。 |

端口或 context-path 若与上文不同，请把 `8002`、`/xiaozhi` 改成你本地的配置。
