# 声纹服务对接与测试操作文档

本文档说明如何**对接声纹服务**并在 xiaozhi-server + 智控台 环境下**完整测试声纹识别**，包括：声纹服务 API 约定、部署与配置、智控台操作、测试步骤及常见问题。

---

## 一、声纹服务 API 约定（对接必读）

若你**自建或对接第三方声纹服务**，需实现以下接口。xiaozhi-server 与 manager-api 会按下列方式调用。

### 1.1 基础约定

- **Base URL**：例如 `http://your-host:8005`，所有接口均在该 host 下。
- **鉴权**：URL 查询参数中需带 **key**，例如 `http://your-host:8005/voiceprint/health?key=your_secret_key`。  
  请求头使用 **Authorization: Bearer {key}**（key 为上述查询参数中的 key 值）。
- **音频格式**：识别/注册接口接收的音频为 **WAV**（xiaozhi-server 会将 PCM 转为 WAV 再上传）。

### 1.2 健康检查（GET）

| 项目 | 说明 |
|------|------|
| **URL** | `GET {base}/voiceprint/health?key={api_key}` |
| **Headers** | 无强制要求（部分实现用 key 做校验即可） |
| **响应** | HTTP 200，且 **响应体中出现字符串 "healthy"**（如 `{"status":"healthy"}` 或 `{"status":"healthy","total_voiceprints":0}`）。 |
| **用途** | 智控台保存参数时会请求该 URL 校验「声纹接口是否可用」；xiaozhi-server 启动 VoiceprintProvider 时也会做健康检查，不通过则禁用声纹。 |

### 1.3 识别（POST）— xiaozhi-server 调用

| 项目 | 说明 |
|------|------|
| **URL** | `POST {base}/voiceprint/identify` |
| **Headers** | `Authorization: Bearer {api_key}`，`Content-Type: multipart/form-data`（由客户端设置）。 |
| **Body（form-data）** | **speaker_ids**：逗号分隔的说话人 ID 列表，如 `id1,id2,id3`；**file**：WAV 音频文件（key 为 `file`，filename 建议 `audio.wav`）。 |
| **响应** | HTTP 200，JSON  body 需包含：**speaker_id**（匹配到的说话人 ID，字符串）、**score**（相似度，0.0～1.0 的浮点数）。 |
| **示例** | `{"speaker_id": "abc123", "score": 0.85}` |

xiaozhi-server 会根据 **score** 与配置的 **similarity_threshold** 比较，低于阈值则视为「未知说话人」；若 speaker_id 在当次下发的 speakers 列表中，则返回对应**名称**给业务使用。

### 1.4 注册（POST）— 智控台 manager-api 调用

| 项目 | 说明 |
|------|------|
| **URL** | `POST {base}/voiceprint/register` |
| **Headers** | `Authorization: Bearer {api_key}`，`Content-Type: multipart/form-data`。 |
| **Body（form-data）** | **speaker_id**：本次注册的说话人 ID（与智控台声纹记录 id 一致）；**file**：WAV 音频文件。 |
| **响应** | HTTP 200，且响应体中出现 **"true"** 表示成功（如 `true` 或 `{"success":true}`）。 |

智控台在「添加/更新声纹」时，会从聊天记录中取一条该智能体下的语音，调用此接口完成注册。

### 1.5 注销（DELETE）— 智控台 manager-api 调用

| 项目 | 说明 |
|------|------|
| **URL** | `DELETE {base}/voiceprint/{speaker_id}` |
| **Headers** | `Authorization: Bearer {api_key}` |
| **响应** | HTTP 200。 |

智控台在「删除声纹」时调用，用于在声纹服务侧删除该 speaker_id 的模型。

---

## 二、使用官方声纹服务（voiceprint-api）部署

若使用项目推荐的 **voiceprint-api** 服务，可直接参考现有文档并按以下要点操作。

### 2.1 文档与仓库

- **对接与部署说明**：见仓库内 **`docs/voiceprint-integration.md`**（包含下载、数据库、docker 启动、智控台参数配置、最简本地配置等）。
- **声纹项目地址**：https://github.com/xinnan-tech/voiceprint-api

### 2.2 关键步骤摘要

1. **下载并部署 voiceprint-api**  
   创建数据库 `voiceprint_db` 与表 `voiceprints`，配置 `data/.voiceprint.yaml` 中的 MySQL 连接；Docker 部署时 MySQL 的 host 需填**宿主机/局域网 IP**，不能填 `127.0.0.1`。
2. **得到声纹接口地址**  
   启动后日志会打印类似：`声纹接口地址: http://127.0.0.1:8005/voiceprint/health?key=abcd`。  
   **若为 Docker 或远程部署**：将 `127.0.0.1` 改为**本机或声纹服务所在机器的局域网 IP**，例如 `http://192.168.1.25:8005/voiceprint/health?key=abcd`。
3. **浏览器校验**  
   浏览器访问上述地址，应返回包含 `"healthy"` 的 JSON，如：`{"total_voiceprints":0,"status":"healthy"}`。

---

## 三、智控台（全模块）配置声纹

以下为**接智控台 + manager-api** 时的完整操作顺序。

### 3.1 开启声纹识别功能开关

1. 管理员登录 **智控台（manager-web）**。
2. 顶部 **参数字典** → **系统功能配置**。
3. 勾选 **「声纹识别」**，保存。  
   保存后，在**智能体/设备卡片**上会出现 **「声纹识别」** 按钮，用于进入声纹管理页。

### 3.2 配置声纹接口地址（参数 server.voice_print）

1. 顶部 **参数字典** → **参数管理**。
2. 搜索参数 **`server.voice_print`**。
3. 点击修改，将 **参数值** 设为你在第二节得到的 **声纹接口地址**（必须带 `?key=xxx`），例如：  
   `http://192.168.1.25:8005/voiceprint/health?key=abcd`
4. 保存。

**说明**：

- 智控台保存时会对该 URL 发 **GET** 请求；若返回非 200 或响应体不含 `"healthy"`，会提示校验失败。
- 智控台**不允许**配置为 `localhost` 或 `127.0.0.1`（校验会报错）。若声纹服务在本机，需用本机局域网 IP 或通过内网穿透/反向代理暴露为可访问的 http 地址。

### 3.3 可选：调整相似度阈值

- 参数 **`server.voiceprint_similarity_threshold`**：声纹识别相似度阈值，范围 0.0～1.0，默认 **0.4**。  
- 数值越大识别越严格，误识别为「某人」的概率降低，但漏识别（判为未知）会增多；可根据实际效果调整。

### 3.4 设备与智能体

- 设备需**已绑定**到某智能体（否则拉不到私有配置，也不会带声纹）。
- 声纹是按**智能体**维度的：一个智能体下可配置多条声纹（多个说话人）；设备绑定该智能体后，会拉取到该智能体下所有声纹列表用于识别。

---

## 四、在智控台添加/管理声纹（录入说话人）

### 4.1 前置条件

- 已完成 **三、3.1～3.2**（功能开关已开、`server.voice_print` 已配置且校验通过）。
- 该智能体已开启**记忆**（建议「本地短期记忆」），并开启**「上报文字+语音」**，以便有语音记录可供选做声纹样本。

### 4.2 添加声纹步骤

1. 在 **智能体管理 / 首页** 中，找到目标智能体卡片，点击 **「声纹识别」**。
2. 进入声纹管理页后，点击 **「添加」**（或「新增」）。
3. 在弹窗中：  
   - **声纹向量（语音消息）**：从下拉列表中选择一条**该智能体下的聊天语音**（即某次对话中用户或设备的语音记录），作为声纹注册的音频。  
   - **姓名（sourceName）**：填写该说话人的称呼，如「小明」「爸爸」。  
   - **描述（introduce）**：建议填写，如「家里孩子，5 岁，喜欢恐龙」，便于后续在 system prompt 中展示给模型。
4. 提交保存。

**后端逻辑**：智控台会将该条语音的音频 ID 传给 manager-api，manager-api 拉取对应 WAV，调用声纹服务的 **POST /voiceprint/register**，并在库表 **ai_agent_voice_print** 中插入一条记录（id、agent_id、source_name、introduce、audio_id 等）。设备拉取私有配置时，会得到 **voiceprint.speakers**，每项格式为 `"id,名称,描述"`。

### 4.3 编辑 / 删除声纹

- **编辑**：可修改姓名、描述，或更换「声纹向量」对应的语音后重新注册（会调 register，必要时先调 DELETE 再 register）。  
- **删除**：删除该条声纹时，manager-api 会调用声纹服务的 **DELETE /voiceprint/{speaker_id}**，并删除库表记录。

---

## 五、xiaozhi-server 侧（连接与识别流程）

### 5.1 配置来源

- 当 **read_config_from_api = True**（从智控台拉配置）时，设备连接后会在 **get_agent_models** 的返回中拿到 **voiceprint**：  
  **url**（带 key）、**speakers**（`["id1,名称1,描述1","id2,名称2,描述2",...]`）、**similarity_threshold**（可选）。
- connection 在 **\_initialize_voiceprint()** 中用该 config 创建 **VoiceprintProvider**；若 **url** 和 **speakers** 有效且**健康检查通过**，则 **voiceprint_provider** 启用。

### 5.2 识别时机与数据流

- **ASR** 在「一段语音结束」时（如 VAD 检测到静音或客户端发 listen stop），会将本段 PCM 转为 WAV，与 ASR 识别**并发**调用 **conn.voiceprint_provider.identify_speaker(wav_data, session_id)**。
- 声纹服务返回 **speaker_id + score**；若 score ≥ threshold 且 speaker_id 在 speakers 中，则得到**说话人名称**，写入本段识别结果（如 `{"speaker":"小明","content":"今天天气怎么样"}`），并设置 **conn.current_speaker**。
- 该结果会进入 **startToChat** → **chat**，对话与记忆可据此区分说话人（当前记忆仍按 device_id，按孩子隔离需见「设备绑定与孩子声纹偏好」文档）。

---

## 六、测试声纹的完整流程（推荐步骤）

### 6.1 环境准备

- 声纹服务已部署并可访问（浏览器能打开 `http://{ip}:{port}/voiceprint/health?key=xxx` 且返回含 "healthy"）。
- manager-api + manager-web 已部署；xiaozhi-server 已配置为从智控台拉配置（如 `data/.config.yaml` 中配置 manager-api.url，启动后 read_config_from_api 为 True）。
- 至少一个**已绑定**的设备和对应智能体；或使用 **test page** 时，先用设备上报接口为该 device-id 写入绑定码并完成绑定，再用该 device-id 连接（见「测试页面与设备绑定流程说明」）。

### 6.2 智控台配置与录入

1. **系统功能配置**：勾选「声纹识别」并保存。  
2. **参数管理**：`server.voice_print` 设为声纹接口地址（含 key），保存（通过校验）。  
3. **智能体**：进入目标智能体 → **声纹识别** → **添加**，选择一条聊天语音，填写姓名和描述，保存。  
4. 可再添加一条不同人的声纹，便于测试多说话人。

### 6.3 使用真实设备或 test page 测试

- **设备**：设备连接 xiaozhi-server（带已绑定的 device-id），说一句话；在智控台或日志中查看该次会话是否有「说话人」信息。  
- **test page**：  
  - 设置 OTA/WebSocket 地址，设备 MAC 填已绑定设备的 device-id；  
  - 连接后发**语音**或**文本**（若前端支持带 type/listen 的文本，可模拟）；  
  - 查看 xiaozhi-server 日志中是否有「声纹识别成功: xxx (相似度: x.xxx)」或「识别说话人: xxx」。

### 6.4 日志与自检

- **xiaozhi-server 日志**：  
  - 连接时：`声纹识别已启用: API=..., 说话人=N个, 相似度阈值=0.4` 表示 VoiceprintProvider 启用成功。  
  - 识别时：`声纹识别成功: 小明 (相似度: 0.xx)` 或 `声纹识别相似度x.xx低于阈值`、`未识别的说话人ID`。  
- **健康检查失败**：若出现「声纹识别服务器不可用，声纹识别已禁用」，请检查：  
  - 声纹服务是否启动、端口是否可达；  
  - url 中 key 是否正确；  
  - 健康检查返回是否包含 "healthy"（见 1.2）。

---

## 七、最简部署（不接智控台）时如何测声纹

若不使用智控台，仅用**本地配置文件**：

1. 在 **xiaozhi-server** 的 **`data/.config.yaml`** 中增加 **voiceprint** 段（与现有配置合并，注意 YAML 层级）：

```yaml
voiceprint:
  url: "http://你的声纹服务地址/voiceprint/health?key=你的key"
  similarity_threshold: 0.4
  speakers:
    - "speaker_id_1,张三,张三是一名程序员"
    - "speaker_id_2,李四,李四是产品经理"
```

2. **speaker_id** 需与声纹服务里已注册的 ID 一致；若使用 voiceprint-api，需先用其 **/voiceprint/register** 接口（或 openapi 文档）为每个 speaker_id 注册一段 WAV。  
3. 启动 xiaozhi-server，连接时不会走 get_agent_models，直接使用本地 config 中的 voiceprint；若 url/speakers 正确且健康检查通过，日志中会出现「声纹识别已启用」。

---

## 八、常见问题

| 现象 | 可能原因 | 处理建议 |
|------|----------|----------|
| 智控台保存 server.voice_print 报错「localhost/127.0.0.1 不允许」 | 参数校验禁止本机地址 | 改为本机局域网 IP 或可被智控台访问的 http 地址。 |
| 保存时报「声纹接口校验失败」或「无法访问」 | GET 健康检查失败 | 确认声纹服务已启动、端口开放、返回含 "healthy"；若智控台与声纹不在同一机器，检查网络/防火墙。 |
| 智控台声纹列表页打不开或提示「声纹接口未配置」 | server.voice_print 为 null 或未保存 | 先在参数管理中配置并保存 `server.voice_print`。 |
| 添加声纹时没有可选的「语音消息」 | 该智能体下没有带语音的聊天记录 | 开启记忆并开启「上报文字+语音」，先用设备/对话产生一段语音再添加声纹。 |
| xiaozhi 日志「声纹识别功能未启用」或「未配置有效的说话人」 | 未拉取到 voiceprint 或 speakers 为空 | 确认设备已绑定、该智能体下已添加至少一条声纹；若用本地配置，检查 .config.yaml 中 voiceprint.speakers 非空。 |
| 识别结果一直是「未知说话人」 | 相似度低于阈值或 speaker_id 不匹配 | 适当调低 `server.voiceprint_similarity_threshold`；确认声纹是用清晰、足够的同一人语音注册的；看日志中的 score 与 threshold。 |
| 声纹服务返回 401/403 | key 错误或鉴权方式不一致 | 确认 URL 中 key 与请求头 Authorization Bearer 的 key 一致；与声纹服务文档对照鉴权方式。 |

---

## 九、相关文档

- **声纹识别启用与部署**：`docs/voiceprint-integration.md`  
- **设备绑定与声纹现有逻辑**：`docs/设备绑定与声纹-现有逻辑说明.md`  
- **测试页面与设备绑定**：`docs/测试页面与设备绑定流程说明.md`  
- **一设备多孩子与声纹**：`docs/设备绑定与孩子声纹偏好产品化流程设计.md`

按上述步骤即可完成声纹服务的对接与测试；若你使用的是自研声纹服务，只需按 **第一节 API 约定** 实现 health、identify、register、DELETE 四个接口即可与现有系统对接。
