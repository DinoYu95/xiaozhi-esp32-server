# 测试页面（test page）与设备绑定流程说明

用 **test page**（Web 测试页）时，为什么看不到「绑定码」、绑定流程什么时候会走，本文说明清楚。

---

## 一、Test Page 怎么连

1. **设置里的「设备MAC」**就是连接时用的 **device-id**  
   - 在设置弹窗里有一个输入框：**设备MAC**（placeholder 是 `device-id`）。  
   - 若未改过，页面会用一个 **随机生成的 MAC**（如 `1A:2B:3C:4D:5E:6F`）并存在 localStorage。  
   - 连接时通过 **hello** 消息和 WebSocket 相关逻辑，把这个值当作 **device-id** 发给 xiaozhi-server。

2. **连接步骤**  
   - 先填 **OTA 服务器地址**（如 `http://127.0.0.1:8002/xiaozhi/ota/`），点 **拨号** 等拿到 WebSocket 地址并建连。  
   - 建连后发 **hello**（里含 `device_id` / deviceMac 等），服务器回 hello 即握手成功。  
   - 之后发语音或文字，走正常对话或「未绑定」提示。

所以：**test page 一定会带一个 device-id（你看到的「设备MAC」），但不会单独显示「绑定码」**，绑定码只会在某种情况下出现在**服务器返回的语音/文字内容**里（见下）。

---

## 二、配置来自 manager-api 时，绑定逻辑一定会跑

**若你确认服务器配置是从 manager-api 拉的（例如 data/.config.yaml 里配了 manager-api.url，启动时走了 get_config_from_api_async），则 read_config_from_api 为 True，每个连接都会按 device-id 调 get_agent_models，绑定逻辑会执行。** 之前说「read_config_from_api 为 False 所以没有绑定」只适用于**未接智控台、只读本地 config.yaml** 的情况；若你环境是读 manager-api，则**确实有绑定流程**。

---

## 三、为什么你「还是没看到 6 位 code」

即使配置来自 manager-api、绑定流程在跑，test page 上仍可能**看不到 6 位绑定码**，常见原因如下。

1. **10041 vs 10042：绑定码只在 10042 时才有**
   - manager-api 的 **getAgentModels(mac)** 逻辑是：
     - 设备**已在设备表** → 返回配置，need_bind = False。
     - 设备**不在设备表**：
       - 若 **Redis 里已有该 device-id 的待绑定码**（`activation_code`）→ 返回 **10042**，msg 里带 6 位码 → xiaozhi-server 得到 **bind_code**，TTS 会播「输入 XXXXXX，绑定设备」。
       - 若 **Redis 里也没有**该设备的码 → 返回 **10041**（设备未找到）→ need_bind = True 但 **bind_code 为空**，TTS 只会播「没有找到该设备的版本信息」之类，**没有 6 位数字**。

2. **Test page 用的 device-id 通常没有「设备上报」过**
   - Redis 里的 **activation_code** 是**设备上报（OTA / checkDeviceActive）**时写入的：真实设备首次连 manager-api 的 device report 接口时，会生成 6 位码并写入 Redis；之后同一 device-id 再连 WebSocket 调 get_agent_models 才会拿到 10042 和该码。
   - **Test page 只发 WebSocket hello（带 device-id），不会调设备上报接口**。因此你用的「设备MAC」若是随机或从未被设备上报过的值，Redis 里就没有这个 device-id 的 activation_code，接口只会返回 **10041**，不会返回 10042，所以**不会出现 6 位码**。

3. **若该 device-id 已在智控台绑定**
   - 设备已在设备表 → 直接返回配置，need_bind = False，不会走「需要绑定」提示，自然也没有 code。

4. **绑定码出现的形式（没有单独「code」框）**
   - 绑定码**不会**在 test page 上单独显示；只有当 **need_bind == True 且 bind_code 有值**（即 API 返回了 10042）时，TTS 里才会带 6 位数字，例如：「请登录控制面板，输入 **123456**，绑定设备。」在 test page 上这句话就是 **AI 的回复内容**，6 位数字在这句文案里。

---

## 四、绑定流程（在「智控台模式」下）在 test page 上的表现

当 **read_config_from_api = True**（服务器从智控台拉配置）时，流程是这样的：

1. **test page 连接**  
   - 用设置里的「设备MAC」作为 device-id 发 hello，建立 WebSocket。

2. **服务器按 device-id 拉配置**  
   - 调用 manager-api：**POST /config/agent-models**，body 里带 **macAddress**（即 device-id）。

3. **manager-api 判断设备是否已绑定**  
   - 若该 device-id **在设备表里**：返回该设备的智能体/模型等配置 → 服务器 **need_bind = False**，正常对话。  
   - 若 **不在设备表里**：  
     - 若 Redis 里有该设备的**待绑定码** → 返回 **10042**，msg 里带 **6 位绑定码** → 服务器 **need_bind = True**，**bind_code = 该 6 位**。  
     - 若 Redis 里也没有 → 返回 **10041**（设备未找到）→ 服务器 **need_bind = True**，无 bind_code。

4. **你在 test page 上发一条消息（语音或文字）**  
   - 若 **need_bind == True**：  
     - 服务器**不进入正常对话**，而是走「绑定提示」逻辑；  
     - 若有 **bind_code**，会发 TTS：「请登录控制面板，输入 **XXXXXX**，绑定设备。」（**XXXXXX 即 6 位绑定码**）；  
     - 这段 TTS 在 test page 上就是 **AI 的回复内容**，所以你在**聊天区域**能看到/听到这句话，里面的 6 位数字就是你要的「code」。  
   - 若 **need_bind == False**：正常对话，不会有绑定码。

5. **拿到 code 之后**  
   - 到 **智控台 / 管理后台** 的「设备绑定」入口，输入这 6 位 code，完成绑定。  
   - 绑定成功后，该 device-id 会写入设备表；下次 test page 用**同一个设备MAC**再连，就会拿到配置，**need_bind = False**，不再播绑定码。

---

## 五、小结（直接回答「test page 绑定流程是啥、为啥没看到 code」）

| 问题 | 说明 |
|------|------|
| 配置是读 manager-api 的，会有绑定吗？ | **会。** 配置来自 manager-api 时 **read_config_from_api = True**，每个连接都会按 device-id 调 get_agent_models，绑定逻辑会执行。 |
| test page 的「设备MAC」是啥？ | 就是连接时发给服务器的 **device-id**（可随机 MAC 或自己填）。 |
| 绑定流程什么时候会走？ | 当服务器 **read_config_from_api = True**（智控台模式）时，会按 device-id 拉配置并可能进入「未绑定 + 播报绑定码」。 |
| 为啥配置从 manager-api 读，我还是没看到 code？ | 常见原因：**(1)** 该 device-id **已在智控台绑定**，直接返回配置，不会播绑定码；**(2)** 该 device-id **从未经过设备上报**，Redis 里没有 activation_code，接口返回 **10041**（设备未找到），need_bind=True 但 **bind_code 为空**，TTS 只播「没有找到该设备…」，**没有 6 位数字**；**(3)** 绑定码在 **AI 回复的 TTS 文案里**（「输入 XXXXXX，绑定设备」），不是页面上单独的 code 框，要发一条消息后看回复。 |
| 想用 test page 测到 6 位绑定码该怎么做？ | 需要让该 device-id 在 Redis 里有 activation_code，这样 get_agent_models 才会返回 **10042** 并带 code。做法之一：先用**同一 device-id** 调一次 manager-api 的**设备上报接口**（OTA / checkDeviceActive），生成并写入 Redis；再用 test page 用该 device-id 连、发一条消息，即可在 TTS 回复里看到 6 位码。或先用真实设备上报一次，再在 test page 用该设备的 MAC 测试。 |

如果你愿意，我可以再根据你当前是「纯本地 config」还是「已接智控台」帮你对一下 read_config_from_api 实际是 true 还是 false，以及 test page 上具体该点哪、看哪一句才能看到 code。
