# 设备主孩子与声纹功能 — 设计草案

## 一、需求摘要

1. **设备与孩子**：一个设备可添加一个「主孩子」，孩子信息包含基础资料与偏好设置（如生日、性别、爱好等）。
2. **主孩子声纹**：需支持录入该主孩子的声纹；与现有「智能体声纹」能力统一存储与下发，复用手纹表与 `audio_id` 逻辑；声纹表需能区分「是否主孩子声纹」（如增加孩子 id 字段）；非孩子声纹继续用 `source_name` + `introduce` 描述；接口逻辑参考现有后台「添加声纹」流程。

---

## 二、表结构设计

### 2.1 孩子表 `device_child`（新建）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT AUTO_INCREMENT | 主键 |
| device_id | VARCHAR(32) NOT NULL | 设备 ID（= ai_device.id），一个设备仅能绑定一个孩子，唯一索引 |
| name | VARCHAR(64) | 孩子姓名/昵称 |
| avatar_url | VARCHAR(512) | 头像 URL（可选） |
| birthday | DATE | 生日 |
| gender | TINYINT | 性别：0 未知 / 1 男 / 2 女 |
| age_stage | VARCHAR(20) | 年龄段，如 "3-6岁"、"学龄前"、"小学"（可选） |
| hobbies | VARCHAR(500) | 爱好，如 "画画,恐龙,听故事" |
| favorite_topics | VARCHAR(500) | 喜欢的话题或常聊内容 |
| favorite_stories | VARCHAR(500) | 喜欢的故事/绘本（可选） |
| personality_note | VARCHAR(500) | 性格/偏好备注（给 AI 参考） |
| school | VARCHAR(128) | 学校/幼儿园（可选） |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

**说明**：
- `device_id` 与 `ai_device.id` 一致（家长端绑定后拿到的 deviceId 即此值），`UNIQUE(device_id)`，一机一孩。
- 已增加年龄段、喜欢的故事、学校等字段，便于后续在 prompt/记忆里使用。

---

### 2.2 智能体声纹表 `ai_agent_voice_print`（扩表）

**新增字段：**

| 字段 | 类型 | 说明 |
|------|------|------|
| child_id | BIGINT NULL | 关联 device_child.id；非空表示该声纹是「某设备主孩子」的声纹；为空表示来自后台的普通声纹（聊天记录选取或其它） |

**现有字段保持不变**：`id`, `agent_id`, `audio_id`, `source_name`, `introduce`, `creator`, `create_date`, `updater`, `update_date`。

**唯一约束（建议）**：对「孩子声纹」强制一孩一声纹，可加唯一索引 `UNIQUE(agent_id, child_id)`，其中 `child_id` 非空时唯一（MySQL 下可用唯一索引含 `child_id`，多条 `child_id IS NULL` 仍可共存）。

**设计要点**：
- 声纹仍按「智能体」维度：同一智能体下既有后台添加的声纹（child_id = NULL），也可有主孩子声纹（child_id 非空）。
- **一个孩子在该 agent 下仅允许一条声纹**：业务上强制，添加时若该 child_id + agent_id 已存在则做「更新」而非新增。
- `audio_id` 继续复用：孩子声纹的音频来源改为「家长端上传」，上传后得到与现有逻辑一致的 `audio_id`（见下 2.3），写入本表即可。
- 非孩子声纹：`child_id` 为空，仅填 `source_name`、`introduce` 即可；孩子声纹：`child_id` 必填，`source_name`/`introduce` 可与孩子信息同步（如姓名、关系描述）。

---

### 2.3 孩子声纹音频来源与 `audio_id` 复用

**现状**：后台添加声纹时，音频来自「智能体聊天记录」中的某条语音，对应 `ai_agent_chat_audio` 表的一条记录，其主键即 `audio_id`；`AgentVoicePrintServiceImpl.getVoicePrintAudioWAV(agentId, audioId)` 通过 `agentChatAudioService.getAudio(audioId)` 取流，并校验 `isAudioOwnedByAgent(audioId, agentId)`。

**方案（推荐）**：
- **复用 `ai_agent_chat_audio` 表**：家长端上传孩子声纹 WAV 后，后端将文件内容写入 `ai_agent_chat_audio`（与现有聊天音频同一套存储），得到 `audio_id`，再写入 `ai_agent_voice_print`（并设 `child_id`）。
- **逻辑分支**：
  - 若当前添加/更新的是「孩子声纹」（DTO 带 `childId`）：不校验 `isAudioOwnedByAgent`（该音频本身就不属于某条聊天记录），仅校验设备/孩子归属与 agent 归属；取音频仍用 `agentChatAudioService.getAudio(audioId)`。
  - 若为普通声纹（无 `childId`）：保持现有逻辑不变（必须来自该智能体聊天记录）。
- 这样 `audio_id` 语义统一为「某条音频在 ai_agent_chat_audio 中的 id」，设备侧与 voiceprint 服务侧无需区分「来源是聊天还是上传」。

**可选**：若希望物理隔离「聊天音频」与「上传声纹」，可新增表 `voiceprint_audio_upload`（id, file_path 或 blob, create_time），并在 `ai_agent_voice_print` 增加 `audio_source`（'chat' | 'upload'），`audio_id` 按 source 指向不同表；接口与 `getVoicePrintAudioWAV` 内按 source 分支取流。当前草案优先「复用 ai_agent_chat_audio」以少改表、少分支。

---

## 三、接口设计

### 3.1 孩子信息（家长端）

- **添加/绑定主孩子**  
  `POST /parent-api/device/child`  
  - 入参：deviceId（必填）, name, avatarUrl, birthday, gender, hobbies, favoriteTopics, personalityNote 等。  
  - 校验：设备已绑定当前家长；该 device 尚未绑定孩子（或允许覆盖则按产品定）。  
  - 行为：插入或更新 `device_child`（一机一孩）。

- **获取设备主孩子信息**  
  `GET /parent-api/device/child?deviceId=xxx`  
  - 校验：设备属于当前家长。  
  - 返回：孩子完整信息（含 id、name、生日、性别、爱好等）。

- **更新主孩子信息**  
  `PUT /parent-api/device/child/{childId}`  
  - 入参：与添加类似，可部分更新。  
  - 校验：child 属于当前家长（通过 device 归属校验）。

- **解除设备主孩子**  
  `DELETE /parent-api/device/child?deviceId=xxx` 或 `.../child/{childId}`  
  - 校验设备归属后，**物理删除**该孩子关联的 `ai_agent_voice_print` 记录（并调用声纹服务 cancel 注销），再删除 `device_child` 记录。

---

### 3.2 主孩子声纹（家长端）

- **上传孩子声纹音频**  
  `POST /parent-api/device/child/voiceprint/upload`  
  - Content-Type: multipart/form-data，字段：deviceId（或 childId）、agentId（可选，若设备已绑定智能体可后端解析）、file（WAV）。  
  - 行为：校验设备归属与孩子存在；将 WAV 写入 `ai_agent_chat_audio`，返回 `audioId` 给前端（或直接进入「添加声纹」步骤时由后端使用）。

- **添加/录入主孩子声纹**  
  `POST /parent-api/device/child/voiceprint`  
  - 入参：deviceId、childId、agentId、audioId（来自上传接口）、sourceName、introduce（可选，可与孩子信息自动带出）。  
  - 行为：参考后台「添加声纹」逻辑，走「孩子声纹」分支：不校验 `isAudioOwnedByAgent`；**强制一孩一声纹**：若该 child_id + agent_id 已有记录则走更新（先 cancel 再重新 register），否则插入新行并设 `child_id`，然后调用声纹服务 register。

- **更新主孩子声纹**  
  `PUT /parent-api/device/child/voiceprint/{voicePrintId}`  
  - 入参：可更换 audioId（重新上传后再填）、sourceName、introduce。  
  - 逻辑：参考后台「更新声纹」；校验该声纹的 `child_id` 属于当前家长下的孩子；若更换音频则先 cancel 再 register。

- **删除主孩子声纹**  
  `DELETE /parent-api/device/child/voiceprint/{voicePrintId}`  
  - 校验归属后删除 `ai_agent_voice_print` 行并调用声纹服务 cancel。

- **查询设备/孩子下的声纹**  
  `GET /parent-api/device/child/voiceprint?deviceId=xxx` 或 `?childId=xxx`  
  - 返回该设备主孩子在该设备绑定智能体下的声纹列表（含 id、sourceName、introduce、是否已录入等），便于前端展示或引导「去录入」。

---

### 3.3 与现有后台「添加声纹」逻辑的对照

- **后台**：`AgentVoicePrintController.save(AgentVoicePrintSaveDTO)` → `AgentVoicePrintServiceImpl.insert(dto)`：  
  - 用 `dto.getAudioId()` 从聊天记录取 WAV，`isAudioOwnedByAgent(audioId, agentId)` 校验；  
  - 查重（identify）；  
  - 插入 `ai_agent_voice_print`（无 child_id）；  
  - `registerVoicePrint(id, resource)`。

- **家长端孩子声纹**：  
  - 音频来自「上传」→ 先落库 `ai_agent_chat_audio` 得到 `audioId`；  
  - 不校验 `isAudioOwnedByAgent`，只校验设备/孩子/agent 归属；  
  - 可选：同样做 identify 防重复（同一 agent 下是否已存在相似声纹）；  
  - 插入 `ai_agent_voice_print` 时设 `child_id`，其余与现有一致；  
  - 同样调用 `registerVoicePrint(entity.getId(), resource)`。  

建议：新增一个「内部」或重载方法，例如 `insertChildVoicePrint(ChildVoicePrintSaveDTO)`，内部复用 `registerVoicePrint`、`getVoicePrintAudioWAV` 的「仅取流」分支（孩子场景不校验聊天归属），并写 `child_id`；对外仍可保持与现有 SaveDTO 类似的字段结构，仅多 `childId` 和可选 `audioId` 来源说明。

---

## 四、设备拉取私有配置（声纹部分）

- 设备与 agent 一一对应，拉取私有配置时已知 deviceId（或 device 实体，可得到 agent_id 与 device_id）。
- **变更**：build 时传入 **deviceId**，声纹列表过滤为：**该 agent 下「后台声纹」（child_id IS NULL）+「本设备主孩子声纹」（child_id = 本设备绑定的孩子 id）」**，即 `child_id IS NULL OR child_id IN (SELECT id FROM device_child WHERE device_id = ?)`。
- 这样设备只拿到「本设备主孩子 + 后台添加的声纹」，不会拿到其它设备的孩子声纹。

---

## 五、已确认结论

| 项 | 结论 |
|----|------|
| 孩子表 | 新建 `device_child`，一设备一孩，字段含姓名、生日、性别、年龄段、爱好、喜欢的话题/故事、性格备注、学校等 |
| 声纹表 | `ai_agent_voice_print` 增加 `child_id`（NULL 表示非孩子声纹）；**强制一孩子在该 agent 下仅一条声纹** |
| 音频存储 | 孩子声纹 WAV 复用 `ai_agent_chat_audio`，得到 `audio_id` 写入声纹表 |
| 接口 | 家长端：孩子 CRUD、声纹上传、声纹添加/更新/删除/列表；孩子声纹添加时若已存在则更新 |
| 设备配置 | 设备与 agent 一一对应；拉取声纹时按 deviceId 过滤为「本设备主孩子 + 后台声纹」 |
| 解除孩子 | **物理删除**：先删该孩子关联的声纹记录（并 cancel），再删 `device_child` |

可按此方案实施库表变更与接口实现。
