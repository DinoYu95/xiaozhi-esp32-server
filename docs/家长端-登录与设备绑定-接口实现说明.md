## 家长端登录与设备绑定接口实现说明

本文档描述 `manager-api` 中家长端登录与设备绑定相关接口的**最终实现形态**，便于前后端自测与联调。所有接口均默认基于：

- 基础地址：`http://localhost:8002/xiaozhi`
- 统一返回结构：`{ code, msg, data }`，其中 `code=0` 表示成功。

---

### 一、登录与用户接口（/parent-api/auth/**）

#### 1. 发送手机验证码

- **URL**：`POST /parent-api/auth/phone/code`
- **说明**：给手机号发送短信验证码。当前测试环境一般通过 Redis 直接写入验证码，不强依赖真实短信。
- **请求体**：

```json
{ "phone": "13800138000" }
```

- **本地测试（mock 验证码）**：

```bash
redis-cli
SET "sys:captcha:sms:Validate:Code:13800138000" "123456"
EXPIRE "sys:captcha:sms:Validate:Code:13800138000" 300
```

- **curl 示例**：

```bash
curl -X POST "http://localhost:8002/xiaozhi/parent-api/auth/phone/code" \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```

---

#### 2. 手机号 + 验证码登录

- **URL**：`POST /parent-api/auth/phone/login`
- **说明**：
  - 校验 Redis 中的短信验证码；
  - 按手机号查找或新建家长用户（`parent_user`）；
  - 写入 `parent_user_token`，生成家长端 token。
- **请求体**：

```json
{ "phone": "13800138000", "code": "123456" }
```

- **返回示例**：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "token": "PARENT_TOKEN",
    "expireAt": 1740000000000,
    "user": {
      "id": 1,
      "nickname": null,
      "avatarUrl": null,
      "phone": "138****8000"
    }
  }
}
```

- **curl 示例**：

```bash
curl -X POST "http://localhost:8002/xiaozhi/parent-api/auth/phone/login" \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","code":"123456"}'
```

> 说明：后续接口中的 `PARENT_TOKEN` 均指此处返回的 `data.token`。

---

#### 3. 当前家长信息

- **URL**：`GET /parent-api/auth/info`
- **鉴权**：需在 Header 中携带：

```text
Authorization: Bearer PARENT_TOKEN
```

- **返回示例**：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": 1,
    "nickname": "测试家长",
    "avatarUrl": "https://example.com/avatar.png",
    "phone": "138****8000"
  }
}
```

- **curl 示例**：

```bash
curl -X GET "http://localhost:8002/xiaozhi/parent-api/auth/info" \
  -H "Authorization: Bearer PARENT_TOKEN"
```

---

#### 4. 更新家长个人信息

- **URL**：`PUT /parent-api/auth/profile`
- **鉴权**：同上，需 `Authorization: Bearer PARENT_TOKEN`。
- **说明**：
  - 支持更新 `nickname`、`avatarUrl`、`phone`；
  - `phone` 写入数据库前会使用 AES 加密存储（字段 `parent_user.phone`）。
- **请求体示例**：

```json
{
  "nickname": "测试家长",
  "avatarUrl": "https://example.com/avatar.png",
  "phone": "13800138000"
}
```

- **返回**：`code=0` 表示成功，无 data。
- **curl 示例**：

```bash
curl -X PUT "http://localhost:8002/xiaozhi/parent-api/auth/profile" \
  -H "Authorization: Bearer PARENT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"nickname":"测试家长","avatarUrl":"https://example.com/avatar.png","phone":"13800138000"}'
```

> 若返回 `code=401` 或 `code=20001(PARENT_TOKEN_INVALID)`，优先检查 token 是否用的是最新一次登录返回的值，以及 Header 是否为 `Authorization: Bearer 实际token字符串`。

---

#### 5. 家长登出

- **URL**：`POST /parent-api/auth/logout`
- **鉴权**：同上。
- **说明**：删除当前 token 对应的 `parent_user_token` 记录。
- **curl 示例**：

```bash
curl -X POST "http://localhost:8002/xiaozhi/parent-api/auth/logout" \
  -H "Authorization: Bearer PARENT_TOKEN"
```

---

### 二、设备绑定接口（/parent-api/device/**）

#### 0. 测试辅助：生成绑定码（模拟设备）

- **URL**：`GET /ota/test-binding-code?Device-Id={deviceMac}`
- **说明**：
  - 在 Redis 中写入和真实 OTA 上报一致的两类 key：
    - `ota:activation:code:{code} -> deviceId`
    - `ota:activation:data:{safeDeviceId} -> {activation_code, mac_address, board, app_version,...}`
  - 供 `test_page.html` 或 curl 获取绑定码，用于测试家长端 `/device/bind`。
- **返回示例**：

```json
{ "code": "123456" }
```

- **curl 示例**：

```bash
curl "http://localhost:8002/xiaozhi/ota/test-binding-code?Device-Id=aa:bb:cc:dd:ee:01"
```

---

#### 1. 通过绑定码绑定设备

- **URL**：`POST /parent-api/device/bind`
- **鉴权**：`Authorization: Bearer PARENT_TOKEN`
- **请求体**：

```json
{ "code": "123456" }
```

- **主要逻辑**：
  1. 使用 `code` 从 Redis 读取 `ota:activation:code:{code} -> deviceId`；
  2. 使用 `deviceId` 派生 `safeDeviceId`，从 `ota:activation:data:{safeDeviceId}` 读取设备信息并校验；
  3. 若 `ai_device` 不存在，则按默认 `agentId` 创建新设备；否则仅建立绑定关系；
  4. 在 `parent_device_binding` 写入 `parent_user_id + device_id`；
  5. 删除 Redis 中对应的绑定码缓存。

- **返回示例**：

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "deviceId": "aa:bb:cc:dd:ee:01",
    "message": "绑定成功"
  }
}
```

- **curl 示例**：

```bash
curl -X POST "http://localhost:8002/xiaozhi/parent-api/device/bind" \
  -H "Authorization: Bearer PARENT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"code":"123456"}'
```

---

#### 2. 解绑设备

- **URL**：`POST /parent-api/device/unbind`
- **鉴权**：`Authorization: Bearer PARENT_TOKEN`
- **请求体**：

```json
{ "deviceId": "aa:bb:cc:dd:ee:01" }
```

- **说明**：
  - 仅删除 `parent_device_binding` 中当前家长与该设备的绑定关系；
  - 不删除 `ai_device` 记录，设备仍可被后台管理使用。

- **curl 示例**：

```bash
curl -X POST "http://localhost:8002/xiaozhi/parent-api/device/unbind" \
  -H "Authorization: Bearer PARENT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"deviceId":"aa:bb:cc:dd:ee:01"}'
```

---

#### 3. 已绑定设备列表

- **URL**：`GET /parent-api/device/list`
- **鉴权**：`Authorization: Bearer PARENT_TOKEN`
- **返回示例**：

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "deviceId": "aa:bb:cc:dd:ee:01",
      "bindTime": "2026-02-27T11:11:11"
    }
  ]
}
```

- **curl 示例**：

```bash
curl -X GET "http://localhost:8002/xiaozhi/parent-api/device/list" \
  -H "Authorization: Bearer PARENT_TOKEN"
```

---

### 三、错误码说明（相关部分）

在家长端登录与设备绑定场景中，主要可能遇到的错误码包括：

- `401 UNAUTHORIZED`：未登录或 token 校验失败（通用错误码）；
- `20001 PARENT_TOKEN_INVALID`：家长 token 无效或已过期；
- `20003 PARENT_PHONE_CODE_INVALID`：手机验证码错误或已过期；
- `20004 PARENT_BIND_CODE_INVALID`：绑定码无效或已过期；
- `20005 PARENT_DEVICE_ALREADY_BOUND`：设备已被其他账号绑定；
- `20006 PARENT_DEVICE_NOT_BOUND`：设备未绑定或不属于当前家长。

前后端联调时，建议优先根据 `code` 判断错误类型，再参考 `msg` 做人类可读提示。

