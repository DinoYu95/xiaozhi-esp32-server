# 家长端 - 设备主孩子与声纹 接口文档与测试 curl

本文档描述**设备主孩子**（一设备一孩）及**主孩子声纹**的接口说明与测试示例。设计详见《设备主孩子与声纹设计草案.md》。

---

## 一、鉴权约定

- 所有下述接口均需**家长端登录**后调用。
- **Header**：`Authorization: Bearer <parent_token>`
- 未带有效 token 返回 **401**。
- 设备相关操作会校验「当前设备是否已绑定当前家长」；孩子/声纹归属通过设备绑定关系校验。

**变量说明（测试时替换）**：

- `BASE_URL`：manager-api 地址，如 `http://localhost:8002`
- `PARENT_TOKEN`：登录后拿到的 token（如微信/手机登录返回的 `data.token`）

---

## 二、设备主孩子接口

### 2.1 添加或更新设备主孩子

**一设备一孩**：同一设备多次调用为更新；未绑孩子时为首填。

| 项目 | 说明 |
|------|------|
| 方法 | `POST` |
| 路径 | `/parent-api/device/child` |
| Content-Type | `application/json` |

**请求体**（DeviceChildSaveDTO）：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| deviceId | string | 是 | 设备 ID（与设备列表中的 deviceId 一致） |
| name | string | 否 | 孩子姓名/昵称 |
| avatarUrl | string | 否 | 头像 URL |
| birthday | string | 否 | 生日，格式 `yyyy-MM-dd` |
| gender | int | 否 | 性别：0 未知 / 1 男 / 2 女 |
| ageStage | string | 否 | 年龄段，如「3-6岁」「学龄前」 |
| hobbies | string | 否 | 爱好，如「画画,恐龙,听故事」 |
| favoriteTopics | string | 否 | 喜欢的话题 |
| favoriteStories | string | 否 | 喜欢的故事/绘本 |
| personalityNote | string | 否 | 性格/偏好备注（给 AI 参考） |
| school | string | 否 | 学校/幼儿园 |

**响应**：`200`，`Result<DeviceChildVO>`，如：

```json
{
  "code": 0,
  "data": {
    "id": 1,
    "deviceId": "aa_bb_cc_dd_ee_ff",
    "name": "小明",
    "avatarUrl": null,
    "birthday": "2020-05-01",
    "gender": 1,
    "ageStage": "3-6岁",
    "hobbies": "恐龙,听故事",
    "favoriteTopics": null,
    "favoriteStories": null,
    "personalityNote": "活泼好动",
    "school": null,
    "createTime": "2026-02-14T10:00:00",
    "updateTime": "2026-02-14T10:00:00"
  }
}
```

**测试 curl**：

```bash
curl -s -X POST "${BASE_URL}/parent-api/device/child" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "aa_bb_cc_dd_ee_ff",
    "name": "小明",
    "birthday": "2020-05-01",
    "gender": 1,
    "ageStage": "3-6岁",
    "hobbies": "恐龙,听故事",
    "personalityNote": "活泼好动"
  }'
```

---

### 2.2 获取设备主孩子信息

| 项目 | 说明 |
|------|------|
| 方法 | `GET` |
| 路径 | `/parent-api/device/child?deviceId={deviceId}` |

**响应**：`200`，`Result<DeviceChildVO>`；该设备未绑孩子时 `data` 为 `null`。

**测试 curl**：

```bash
curl -s -X GET "${BASE_URL}/parent-api/device/child?deviceId=aa_bb_cc_dd_ee_ff" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"
```

---

### 2.3 更新主孩子信息

| 项目 | 说明 |
|------|------|
| 方法 | `PUT` |
| 路径 | `/parent-api/device/child` |
| Content-Type | `application/json` |

**请求体**（DeviceChildUpdateDTO）：`childId` 必填，其余为可选更新字段。

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| childId | long | 是 | 孩子 ID（来自 2.1/2.2 的 data.id） |
| name / avatarUrl / birthday / gender / ageStage / hobbies / favoriteTopics / favoriteStories / personalityNote / school | 同 2.1 | 否 | 只传要更新的字段即可 |

**响应**：`200`，`Result<Void>`（code=0 即成功）。

**测试 curl**：

```bash
curl -s -X PUT "${BASE_URL}/parent-api/device/child" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "childId": 1,
    "name": "小明",
    "hobbies": "恐龙,听故事,画画"
  }'
```

---

### 2.4 解除设备主孩子

**物理删除**：会同时删除该孩子在该设备对应智能体下的声纹记录（并调用声纹服务 cancel）。

| 项目 | 说明 |
|------|------|
| 方法 | `DELETE` |
| 路径 | `/parent-api/device/child?deviceId={deviceId}` |

**响应**：`200`，`Result<Void>`。

**测试 curl**：

```bash
curl -s -X DELETE "${BASE_URL}/parent-api/device/child?deviceId=aa_bb_cc_dd_ee_ff" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"
```

---

## 三、主孩子声纹接口

### 3.1 上传孩子声纹音频

上传 WAV 音频并落库，返回 **audioId**，供 3.2 保存声纹时使用。**需先有设备主孩子**（2.1）。

| 项目 | 说明 |
|------|------|
| 方法 | `POST` |
| 路径 | `/parent-api/device/child/voiceprint/upload` |
| Content-Type | `multipart/form-data` |

**参数**：

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| deviceId | string | 是 | 设备 ID |
| file | file | 是 | WAV 音频文件（建议 ≤10MB） |

**响应**：`200`，`Result<String>`，`data` 为音频 ID（如 UUID），示例：

```json
{ "code": 0, "data": "a1b2c3d4e5f6..." }
```

**测试 curl**：

```bash
# 将 /path/to/child_voice.wav 换成实际 WAV 路径
curl -s -X POST "${BASE_URL}/parent-api/device/child/voiceprint/upload" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -F "deviceId=aa_bb_cc_dd_ee_ff" \
  -F "file=@/path/to/child_voice.wav"
```

---

### 3.2 添加或更新主孩子声纹（一孩一声纹）

同一孩子在同一设备对应智能体下**至多一条声纹**：已存在则更新（先 cancel 再重新 register），否则新增。

| 项目 | 说明 |
|------|------|
| 方法 | `POST` |
| 路径 | `/parent-api/device/child/voiceprint` |
| Content-Type | `application/json` |

**请求体**（ChildVoicePrintSaveDTO）：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| deviceId | string | 是 | 设备 ID |
| childId | long | 是 | 孩子 ID（来自 2.1/2.2 的 data.id） |
| audioId | string | 是 | 上传接口（3.1）返回的 data |
| sourceName | string | 是 | 声纹来源姓名（如孩子昵称） |
| introduce | string | 否 | 描述（如「家里孩子，5 岁」） |

**响应**：`200`，`Result<Void>`。

**测试 curl**（先执行 3.1 拿到 `audioId` 再调用）：

```bash
AUDIO_ID="a1b2c3d4e5f6..."   # 从 3.1 返回的 data 填入
curl -s -X POST "${BASE_URL}/parent-api/device/child/voiceprint" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"deviceId\": \"aa_bb_cc_dd_ee_ff\",
    \"childId\": 1,
    \"audioId\": \"${AUDIO_ID}\",
    \"sourceName\": \"小明\",
    \"introduce\": \"家里孩子，5岁，喜欢恐龙\"
  }"
```

---

### 3.3 查询设备主孩子的声纹列表

返回该设备主孩子在该设备绑定智能体下的声纹，**0 或 1 条**。

| 项目 | 说明 |
|------|------|
| 方法 | `GET` |
| 路径 | `/parent-api/device/child/voiceprint?deviceId={deviceId}` |

**响应**：`200`，`Result<List<AgentVoicePrintVO>>`，示例：

```json
{
  "code": 0,
  "data": [
    {
      "id": "vp-uuid-xxx",
      "audioId": "a1b2c3d4...",
      "sourceName": "小明",
      "introduce": "家里孩子，5岁，喜欢恐龙",
      "createDate": "2026-02-14T10:00:00"
    }
  ]
}
```

**测试 curl**：

```bash
curl -s -X GET "${BASE_URL}/parent-api/device/child/voiceprint?deviceId=aa_bb_cc_dd_ee_ff" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"
```

---

### 3.4 删除主孩子声纹

仅允许删除「主孩子声纹」（即带 child_id 的声纹）；归属通过「该声纹对应孩子所属设备是否绑定当前家长」校验。

| 项目 | 说明 |
|------|------|
| 方法 | `DELETE` |
| 路径 | `/parent-api/device/child/voiceprint?voicePrintId={voicePrintId}` |

**响应**：`200`，`Result<Void>`。

**测试 curl**：

```bash
# voicePrintId 来自 3.3 返回的 data[].id
curl -s -X DELETE "${BASE_URL}/parent-api/device/child/voiceprint?voicePrintId=vp-uuid-xxx" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"
```

---

## 四、完整测试流程（curl 串联）

以下为按顺序执行的一键测试流程（需先替换 `BASE_URL`、`PARENT_TOKEN`、`deviceId`，并准备一个 WAV 文件路径）。

```bash
# 1. 环境变量（请替换）
export BASE_URL="http://localhost:8002"
export PARENT_TOKEN="your_parent_token_here"
export DEVICE_ID="aa_bb_cc_dd_ee_ff"
export WAV_FILE="/path/to/child_voice.wav"

# 2. 添加/更新设备主孩子
curl -s -X POST "${BASE_URL}/parent-api/device/child" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{\"deviceId\":\"${DEVICE_ID}\",\"name\":\"小明\",\"gender\":1,\"hobbies\":\"恐龙,听故事\"}"

# 3. 获取主孩子信息（可拿到 childId）
curl -s -X GET "${BASE_URL}/parent-api/device/child?deviceId=${DEVICE_ID}" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"

# 4. 上传声纹音频，拿到 audioId（从返回的 data 中取）
UPLOAD_RESP=$(curl -s -X POST "${BASE_URL}/parent-api/device/child/voiceprint/upload" \
  -H "Authorization: Bearer ${PARENT_TOKEN}" \
  -F "deviceId=${DEVICE_ID}" \
  -F "file=@${WAV_FILE}")
echo "$UPLOAD_RESP"
# 若使用 jq：AUDIO_ID=$(echo "$UPLOAD_RESP" | jq -r '.data')

# 5. 保存主孩子声纹（将 CHILD_ID、AUDIO_ID 替换为上面步骤得到的值）
# curl -s -X POST "${BASE_URL}/parent-api/device/child/voiceprint" \
#   -H "Authorization: Bearer ${PARENT_TOKEN}" \
#   -H "Content-Type: application/json" \
#   -d "{\"deviceId\":\"${DEVICE_ID}\",\"childId\":1,\"audioId\":\"${AUDIO_ID}\",\"sourceName\":\"小明\",\"introduce\":\"家里孩子\"}"

# 6. 查询主孩子声纹列表
curl -s -X GET "${BASE_URL}/parent-api/device/child/voiceprint?deviceId=${DEVICE_ID}" \
  -H "Authorization: Bearer ${PARENT_TOKEN}"

# 7. 删除主孩子声纹（可选，将 VOICE_PRINT_ID 换为 6 返回的 id）
# curl -s -X DELETE "${BASE_URL}/parent-api/device/child/voiceprint?voicePrintId=VOICE_PRINT_ID" \
#   -H "Authorization: Bearer ${PARENT_TOKEN}"

# 8. 解除设备主孩子（可选，会同时删该孩子的声纹）
# curl -s -X DELETE "${BASE_URL}/parent-api/device/child?deviceId=${DEVICE_ID}" \
#   -H "Authorization: Bearer ${PARENT_TOKEN}"
```

---

## 五、错误码与说明

| HTTP | code | 说明 |
|------|------|------|
| 401 | 401 | 未登录或 token 无效（未带/错误/过期） |
| 200 | 非 0 | 业务错误，如 20006 设备未绑定或不属于当前家长 |
| 200 | 0 | 成功 |

常见业务错误文案示例：

- 设备未绑定或不属于当前家长
- 请先添加设备主孩子（上传声纹前未绑孩子）
- 孩子与设备不匹配（childId 与 deviceId 不一致）
- 仅可删除主孩子声纹（对非 child 声纹调删除）

---

## 六、与设备拉配置的关系

- 设备拉取私有配置（如 `get_agent_models(mac)`）时，声纹列表会按 **deviceId** 过滤：
  - 仅返回该智能体下 **后台添加的声纹**（child_id 为空）+ **本设备主孩子声纹**（child_id = 该设备主孩子 id）。
- 因此录入主孩子声纹后，设备下次拉配置即可拿到该孩子的 speaker 信息，无需额外接口。

---

## 七、音频与声纹数据存在哪里

### 7.1 家长端上传的 WAV 存在哪里？

家长端调用「上传孩子声纹音频」后，接口把收到的 **WAV 文件二进制** 写入 **`ai_agent_chat_audio`** 表：

- **表**：`ai_agent_chat_audio`
- **列**：`id`（主键，UUID）、`audio`（**LONGBLOB**，即上传的整段 WAV 字节）
- **逻辑**：`ParentDeviceChildVoicePrintServiceImpl.uploadAudio()` → `agentChatAudioService.saveAudio(bytes)`，与智控台「聊天语音」用的是同一张表，只是来源不同（聊天是设备上报的 Opus，家长端是上传的 WAV）。

返回给前端的 **audioId** 就是这条记录的 `id`，后续「保存声纹」时用这个 audioId 关联。

### 7.2 「录入的声纹」存在哪里？

分两块：

| 存什么 | 存在哪 | 说明 |
|--------|--------|------|
| **声纹元数据（谁、属于哪个 agent、用的哪段音频）** | **`ai_agent_voice_print`** 表 | 我们系统里只存这一张「声纹」表：id（= 声纹服务里的 speaker_id）、agent_id、**audio_id**（→ ai_agent_chat_audio.id）、child_id（主孩子时非空）、source_name、introduce 等。 |
| **声纹特征/向量（用于识别的 embedding）** | **声纹服务端**（外部 API） | 调用 `POST /voiceprint/register` 时，把 **speaker_id + 音频文件** 发给声纹服务；声纹服务内部会提取特征并存储，识别时用那里的数据。我们库裡**不存**声纹向量。 |

所以：

- **WAV 音频**：存在 **`ai_agent_chat_audio`**（家长端上传的 WAV 和聊天上报的语音都在这里）。
- **声纹**：元数据在 **`ai_agent_voice_print`**，特征在**声纹服务**；`ai_agent_voice_print.audio_id` 指向用来注册的那段音频在 `ai_agent_chat_audio` 里的 id。

---

## 八、后台音频存放位置与测试 WAV 获取

### 8.1 智控台「选择语音」的音频存在哪里？

xiaozhi 后台在智能体声纹里「从聊天记录选一条语音」作为声纹来源时，对应的音频存在：

| 项目 | 说明 |
|------|------|
| **表名** | `ai_agent_chat_audio` |
| **主键** | `id`（VARCHAR(32)，UUID） |
| **音频内容** | `audio` 列，**LONGBLOB**，存的是**二进制音频** |
| **数据来源** | 设备/端在上报聊天记录时，把 `audioBase64` 解码后写入；表中注释为「音频 opus 数据」，即多为 **Opus** 格式（设备端上报的语音） |

聊天记录表（如 `ai_chat_history`）里会有关联的 `audio_id`，指向 `ai_agent_chat_audio.id`。智控台选中的「某条语音」就是某条 `ai_agent_chat_audio` 记录。

### 8.2 家长端上传要求的是 WAV，没有 WAV 怎么办？

家长端声纹上传接口要求传 **WAV 文件**（声纹服务注册接口约定为 WAV）。若本地没有现成 WAV，可以用下面几种方式得到测试用 WAV：

**方式一：从库里导出一条音频，再转成 WAV**

若库里已有 `ai_agent_chat_audio` 数据（设备曾上报过语音），可先查出一条记录的 `id`，把该行的 `audio`（LONGBLOB）导出为文件，再按实际格式转成 WAV。

- **查一条可用的 id**：  
  `SELECT id FROM ai_agent_chat_audio LIMIT 1;`
- **导出二进制**：LONGBLOB 用 MySQL 命令行直接导出容易乱码，建议用脚本（如 Python/Node）连库查询 `audio` 并写入本地文件（例如 `audio.opus` 或 `audio.bin`）。
- **转 WAV**（若格式为 Opus）：  
  `ffmpeg -i audio.opus -ar 16000 -ac 1 out.wav`  
  若扩展名不对，可先 `mv audio.bin audio.opus` 再执行 ffmpeg。

**方式二：用 ffmpeg 生成一段短静音/测试音（不依赖库里数据）**

```bash
# 约 3 秒静音，16kHz 单声道
ffmpeg -f lavfi -i anullsrc=r=16000:cl=mono -t 3 -q:v 0 silence.wav

# 或 1 秒 440Hz 正弦（仅用于接口连通性测试）
ffmpeg -f lavfi -i "sine=frequency=440:duration=1" -ar 16000 -ac 1 tone.wav
```

**方式三：手机/电脑录一段人声**

用系统录音或录音 App 录几秒人声，导出为 WAV（或录成 mp3 后用 ffmpeg 转 WAV），更接近真实声纹测试。

**方式四：在线 TTS 或其它工具**

用任意 TTS/工具生成一段语音，导出为 WAV 即可。

---

总结：**后台选择的音频**也在 **`ai_agent_chat_audio`** 表的 `audio` 列（LONGBLOB，多为 Opus）；**家长端上传的 WAV** 同样写入该表。家长端上传接口需要 **WAV** 文件，若没有现成 WAV，可从该表导出后转码，或用上述方式二/三/四生成测试 WAV。
