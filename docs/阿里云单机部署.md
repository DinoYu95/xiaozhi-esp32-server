# 阿里云单机部署（manager-api + manager-web + xiaozhi-server）

在一台阿里云 ECS 上，用 **一个目录 + 一个 .env + 一条命令** 跑起整套服务，并自带 MySQL、Redis。不追求复杂编排，尽量少步骤。

---

## 1. 前置条件

- 一台 Linux 服务器（如阿里云 ECS，Ubuntu 20.04+ 或 CentOS 7+）
- 已安装 [Docker](https://docs.docker.com/engine/install/) 和 [Docker Compose](https://docs.docker.com/compose/install/)（v2 的 `docker compose` 或 v1 的 `docker-compose` 均可）

---

## 2. 部署目录结构

在服务器上准备一个目录（例如 `/opt/xiaozhi`），最终结构如下：

```
/opt/xiaozhi/
├── docker-compose.yml   # 从仓库 deploy/docker-compose.yml 复制
├── .env                 # 从 deploy/.env.example 复制后修改
├── init-db/             # 可选，首次与本地库一致时放导出的 SQL（见下文）
├── data/                # 小智服务端配置目录，可选放 .config.yaml
├── models/
│   └── SenseVoiceSmall/
│       └── model.pt     # 语音识别模型，需单独下载
└── uploadfile/          # 智控台上传文件，首次 up 后自动生成
```

---

## 3. 一键部署步骤

### 3.1 复制编排与配置

```bash
# 假设代码在 /path/to/xiaozhi-esp32-server
cd /opt/xiaozhi
cp /path/to/xiaozhi-esp32-server/deploy/docker-compose.yml .
cp /path/to/xiaozhi-esp32-server/deploy/.env.example .env
```

编辑 `.env`，**至少改掉 MySQL 密码**（生产环境必改）：

```bash
nano .env   # 或 vi / vim
# 修改 MYSQL_ROOT_PASSWORD=你的强密码
```

### 3.2 准备数据目录与模型

```bash
mkdir -p data
mkdir -p models/SenseVoiceSmall
```

下载语音识别模型（二选一），放到 `models/SenseVoiceSmall/model.pt`：

- 阿里魔搭：<https://modelscope.cn/models/iic/SenseVoiceSmall/resolve/master/model.pt>
- 或按项目 [Deployment_all.md](./Deployment_all.md) 中的网盘链接下载

```bash
# 示例：用 wget 下载到正确路径
wget -O models/SenseVoiceSmall/model.pt 'https://modelscope.cn/models/iic/SenseVoiceSmall/resolve/master/model.pt'
```

### 3.3 启动全部服务

**方式一：使用预构建镜像（需能拉取仓库镜像）**  
在 `.env` 中设置 `WEB_IMAGE`、`SERVER_IMAGE` 为镜像地址后执行：

```bash
cd /opt/xiaozhi
docker compose up -d
```

**方式二：从源码构建并启动（推荐，环境与依赖均在镜像内）**  
不设 `WEB_IMAGE`/`SERVER_IMAGE` 时，compose 会使用本地 Dockerfile 构建：

```bash
cd /opt/xiaozhi
docker compose up -d --build
```

- **web** 由 `Dockerfile-web` 构建：安装 Node 依赖并构建前端、Maven 打包 Java，运行时 Nginx + `start.sh` 启动后端。  
- **server** 由 `Dockerfile-server-standalone` 构建：安装 `main/xiaozhi-server/requirements.txt`，运行时 `python app.py`。

查看日志确认智控台启动成功：

```bash
docker compose logs -f web
# 看到类似 Started AdminApplication、doc.html 即可
```

### 3.4 首次使用

- 浏览器访问：`http://你的服务器IP:8002`
- 首次打开智控台会要求**注册**，第一个账号即为超级管理员
- 小智服务端：WS 端口 **8000**，HTTP 端口 **8003**（OTA、视觉等）

---

## 4. 首次部署与本地 MySQL 一致（可选）

若希望远程第一次启动时，MySQL 里的表和数据与本地 Docker 里的一致，可以这样做：

### 4.1 在本地导出库

本地先起好 MySQL 容器（本仓库的 compose 或 `docker-compose_all.yml` 均可），然后执行：

```bash
# 库名按你本地实际库名改，常见为 xiaozhi_esp32_server
# 容器名可能是 xiaozhi-mysql 或 xiaozhi-esp32-server-db，用 docker ps 看
docker exec -i xiaozhi-mysql mysqldump -uroot -p123456 --single-transaction --default-character-set=utf8mb4 xiaozhi_esp32_server > init-db/01-dump.sql
```

把 `-p123456` 换成你本地 MySQL 的 root 密码，没有密码就 `-p` 再回车输入。导出的 `01-dump.sql` 放在**部署目录**的 `init-db/` 下（若用本仓库 deploy，则放在 `deploy/init-db/`，部署时一起拷到服务器）。

### 4.2 远程首次启动前放好 SQL

把包含 `init-db/01-dump.sql` 的部署目录拷到服务器（或只在服务器上创建 `init-db` 并把 `01-dump.sql` 放进去），确保目录结构里存在：

```
/opt/xiaozhi/init-db/01-dump.sql
```

然后在远程**第一次**执行（此前不要先单独起过 db，否则数据目录已有数据，init 不会跑）：

```bash
cd /opt/xiaozhi
docker compose up -d
```

MySQL 首次初始化时会自动执行 `init-db/` 下的 `.sql`（按文件名顺序），表和数据会与本地导出一致。

### 4.3 注意

- **仅首次生效**：只有 MySQL 数据卷为空时才会执行 `init-db/` 里的脚本。若远程已经跑过 `docker compose up`，再放 SQL 不会自动导入。
- **若已 up 过还想用 init 数据**：需要先清空 MySQL 数据卷再起一次，例如：
  ```bash
  docker compose down -v    # 会删掉 mysql_data 卷
  # 确认 init-db/01-dump.sql 已放好
  docker compose up -d
  ```
  或不用 init，改为手动导入：`docker exec -i xiaozhi-mysql mysql -uroot -p<密码> xiaozhi_esp32_server < 01-dump.sql`。

---

## 5. 依赖说明（MySQL / Redis）

| 服务        | 用途                     | 默认端口 |
|-------------|--------------------------|----------|
| MySQL (db)  | manager-api（智控台后端）| 3306 仅内网 |
| Redis       | manager-api + xiaozhi-server 缓存/会话等；**已暴露 6379 到主机**，同机 zhiban-agent 等可复用 | 6379 映射到主机 |

---

## 6. 各服务如何启动、安装包与环境

| 服务   | 镜像/构建 | 安装与环境 | 启动方式 |
|--------|-----------|------------|----------|
| **db** | `mysql:8.0` 官方镜像 | 无需额外安装 | 容器启动即跑 MySQL，首次会执行 `init-db/` 下 SQL |
| **redis** | `redis:7-alpine` 官方镜像 | 无需额外安装 | 容器启动即跑 Redis |
| **web**（智控台） | `Dockerfile-web` 构建，或拉取 `WEB_IMAGE` | **构建时**：Node 下 `npm install` + `npm run build`（前端），Maven `mvn package`（Java 后端）；**运行时**：JRE 21 + Nginx + 中文字体 | 容器内执行 `start.sh`：后台启动 Java（`xiaozhi-esp32-api.jar`，端口 8003），前台 Nginx 监听 8002 并反代 `/xiaozhi/` 到 Java |
| **server**（小智服务端） | `Dockerfile-server-standalone` 构建，或拉取 `SERVER_IMAGE` | **构建时**：Python 3.10，`pip install -r main/xiaozhi-server/requirements.txt`（含 torch、funasr、语音/LLM 等），系统包 libopus0、ffmpeg、locale | 容器内 `python app.py`，监听 8000（WS）与 8003（HTTP） |

需要“从零把环境装全”时：在部署目录执行 `docker compose up -d --build`，不设 `WEB_IMAGE`/`SERVER_IMAGE`，即可用仓库内 Dockerfile 完成构建与启动。

---

## 7. 常用命令

```bash
cd /opt/xiaozhi

# 启动
docker compose up -d

# 停止
docker compose down

# 查看日志（智控台 / 小智服务端）
docker compose logs -f web
docker compose logs -f server

# 重启单个服务
docker compose restart web
docker compose restart server
```

---

## 8. 使用预构建或自建镜像

- **不设 `WEB_IMAGE`/`SERVER_IMAGE`**：compose 会使用仓库内 `Dockerfile-web`、`Dockerfile-server-standalone` 从源码构建（`docker compose up -d --build`），所需环境与依赖都在镜像里。
- **使用仓库预构建镜像**：在 `.env` 中设置例如  
  `WEB_IMAGE=ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:web_latest`、  
  `SERVER_IMAGE=ghcr.nju.edu.cn/xinnan-tech/xiaozhi-esp32-server:server_latest`，再 `docker compose up -d` 拉取。
- **使用自建镜像**：本机或 CI 构建后推送到自己的仓库，在 `.env` 中填写 `WEB_IMAGE`、`SERVER_IMAGE` 为你的镜像地址即可。

---

## 9. 小结

- **一条命令**：`docker compose up -d` 启动 manager-api、manager-web、xiaozhi-server、MySQL、Redis。
- **一个配置**：改 `.env` 里的密码和端口即可，不必改 docker-compose 内容。

这样每次部署只需：准备好目录和模型 → 改 `.env` → `docker compose up -d`，尽量简单、可重复。
